<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Upload Your Movie Here</h1>
    <input type="text" placeholder="Movie Title" id="movieTitle">
    <input type="text" placeholder="Movie Duration" id="movieDuration">
    <input type="text" placeholder="Movie Genre" id="movieGenre">
    <input type="text" placeholder="Movie Cast" id="movieCast">
    <input type="text" placeholder="Movie Synopsis" id="movieSynopsis">
    <input type="file" id="movieFile">
    <button id="uploadBtn">Upload Your Movie</button>

    <script type="module">
        // Save the info to the database
        // Upload the movie to the firebase storage

         // Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getDatabase,ref,set,onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
        import { getStorage,ref as stRef,uploadBytesResumable} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js"

        const firebaseConfig = {
          apiKey: "AIzaSyAH6X36Jl-5RPI9vpXrjQFTLvzKRGsutug",
          authDomain: "second-9ea74.firebaseapp.com",
          projectId: "second-9ea74",
          storageBucket: "second-9ea74.appspot.com",
          messagingSenderId: "462314352184",
          appId: "1:462314352184:web:37a81382a6af2d0425c0cd",
          databaseURL: "https://second-9ea74-default-rtdb.firebaseio.com"
        };
        // Global Variable Declarations
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const database = getDatabase();
        const storage = getStorage()

        let movieIndex = 0
        uploadBtn.addEventListener("click",()=>{
            let file = movieFile.files[0]
            let filename = file.name
            let movie = {
                title : movieTitle.value,
                duration : movieDuration.value,
                genre : movieGenre.value,
                cast: movieCast.value,
                synopsis : movieSynopsis.value,
                movieName : filename
            }
            // Save the info into the database
            let movieRef = ref(database,`allMovies/${movieIndex}`)
            set(movieRef,movie)
            console.log(movie)
            // Upload the movie to firebase storage
            let movieStRef = stRef(storage,`${filename}`)
            const uploadTask = uploadBytesResumable(movieStRef,file)
            uploadTask.on("state-changed",(snapshot)=>{
                console.log((snapshot.bytesTransferred/snapshot.totalBytes)*100)
            },
            (error)=>{
                // in case the upload fails
                console.log(err)
            },
            ()=>{
                // handle successful uploads
                console.log("upload is complete")
            }
            )
        })

        let allMovieRef = ref(database,"allMovies")
        onValue(allMovieRef,(snapshot)=>{
            let data = snapshot.val()
            if(data){
                movieIndex = data.length
            }else{
                movieIndex = 0
            }
        })
    </script>
</body>
</html>